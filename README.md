# 🎮 XUnity.AutoTranslator-deepseek - 游戏翻译服务器

基于 SiliconFlow DeepSeek API 的高性能日文游戏文本翻译服务器。

## ✨ 核心特性

- 🚀 **实时翻译** - 秒级响应，支持高并发请求
- 🎯 **智能重试** - 5次自动重试机制，确保翻译成功率
- 📝 **自定义字典** - 支持用户词汇替换，优先匹配长词汇
- 🔄 **格式保留** - 保留原文格式、标签和特殊字符
- 🔍 **日文检测** - 自动检测翻译质量，避免未翻译内容
- ⚡ **高性能** - 基于 gevent 的异步处理，支持30线程并发
- 🎨 **彩色日志** - ANSI彩色终端输出，便于调试和监控

## 📁 项目结构

```
XUnity.AutoTranslator-deepseek/
├── 📄 translator_server.py     # 🌟 主服务器文件（推荐使用打包好的exe文件）
├── 📄 config.json              # 🔧 API 配置文件

```

## 🚀 快速开始

### 1️⃣ 安装依赖
如果你使用的是打包好的exe文件，无需安装依赖。
如果使用的是python脚本，需要安装依赖：
```bash
pip install flask gevent requests
```

### 2️⃣ 配置 API 访问

编辑 `config.json` 文件：

```json
{
  "SF_BASE_URL": "https://api.siliconflow.cn/v1",
  "SF_MODEL_TYPE": "deepseek-ai/DeepSeek-V3.1",
  "SF_API_TOKEN": "Bearer sk-XXXXX"
}
```
如何获取SF_API_TOKEN：
1. 注册登录 [SiliconFlow](https://cloud.siliconflow.cn/i/xCoTy8vo)
2. 导航到 API 密钥
3. 创建新的 API 令牌
4. 复制生成的令牌（格式：`sk-XXXXX`）

**🔑 配置参数详解**:
- `SF_BASE_URL` - SiliconFlow API 基础地址
- `SF_MODEL_TYPE` - 使用的 AI 模型类型
- `SF_API_TOKEN` - API 认证令牌（格式：`Bearer your_token`）

### 3️⃣ 启动服务器

```bash
# 🌟 使用主服务器（推荐）
python translator_server.py

```

✅ **成功启动标志**:
```
服务器在 http://127.0.0.1:4000 上启动
```

### 4️⃣ 配置 Unity AutoTranslator

编辑 `AutoTranslatorConfig.ini`：

```ini
[Service]
Endpoint=CustomTranslate

[Custom]
Url=http://127.0.0.1:4000/translate
```

## 🎯 高级配置

### 📝 自定义字典配置

创建 `用户替换字典.json`：

```json
{
  "オリジナル": "原创",
  "スキル": "技能",
  "アイテム": "物品",
  "魔法": "法术",
  "剣": "长剑",
  "盾": "圆盾"
}
```

**💡 字典特性**:
- 优先匹配长词汇，避免短词干扰
- 支持 Unicode 字符
- 实时加载，修改后即时生效

### ⚙️ 翻译参数调优

在 `translator_server.py` 中调整：

```python
# 🔧 模型参数
model_params = {
    "temperature": 0.7,      # 创造性 (0-1，值越高越随机)
    "max_tokens": 512,       # 最大输出长度
}

# ⚡ 性能参数
max_retries = 5              # 最大重试次数
number_of_threads = 10       # 工作线程数
MAX_THREADS = 30             # 绝对最大线程限制
```

### 🎨 提示词

```python
prompt = '''
你是资深本地化专家，负责将游戏日文文本译为简体中文。接收文本后，按以下要求翻译：
翻译范围：翻译普通日文文本，保留原文叙述风格。
保留格式：保留转义字符、格式标签、换行符等非日文文本内容。
翻译原则：忠实准确，确保语义无误；对露骨性描写，可直白粗俗表述，不删减篡改；对双关语等特殊表达，找目标语言等效表达，保原作意图风格。
文本类型：游戏文本含角色对话、旁白、武器及物品名称、技能描述、格式标签、换行符、特殊符号等。
以下是待翻译的游戏文本：
'''
```

## 🌐 API 接口详解

### 翻译接口

**📡 端点**: `GET /translate`

**📋 参数**:
- `text` (必需): 需要翻译的文本（URL编码）

**🎯 示例请求**:

```bash
# 🧪 使用 curl 测试
curl "http://127.0.0.1:4000/translate?text=%E3%81%93%E3%82%93%E3%81%AB%E3%81%A1%E3%81%AF%E4%B8%96%E7%95%8C"

# 🌐 浏览器访问
http://127.0.0.1:4000/translate?text=こんにちは世界

```

**📊 响应格式**:
- ✅ 成功: 返回纯文本翻译结果
- ❌ 失败: 返回错误信息和 HTTP 500 状态码

## 🔧 核心功能详解

### 1️⃣ 翻译处理流程

```
输入文本 → URL解码 → 字典匹配 → API调用 → 后处理 → 质量检查 → 输出结果
     ↓           ↓         ↓        ↓        ↓         ↓
  原始日文    还原编码   词汇替换   AI翻译   格式修正   日文检测
```

### 2️⃣ 智能后处理

- **引号处理**: 保留日文引号 `「」`
- **标点修正**: 自动修正中文标点（，。？...）
- **格式保留**: 保持换行符和特殊标签
- **句末一致性**: 确保原文和译文标点一致

### 3️⃣ 错误处理机制

| 错误类型 | 处理方式 | 重试次数 |
|---------|----------|----------|
| 网络超时 | 自动重试 | 最多5次 |
| API错误 | 异常捕获 | 立即返回 |
| 日文残留 | 重新翻译 | 最多5次 |
| 配置缺失 | 默认配置 | 自动创建 |

## 📦 构建和分发

### 🏗️ 打包为可执行文件

```bash
# 📦 使用 PyInstaller 打包
pyinstaller --onefile translator_server.py

```

**📁 输出位置**: `dist/translator_server.exe`

## 🔍 调试和监控

### 📊 日志输出格式

```
[原文] こんにちは世界                    # 🔵 蓝色：原文
[译文] 你好世界                          # 🔴 红色：译文
API请求失败，正在进行第 1 次重试...      # 🟡 黄色：警告信息
检测到译文中包含日文字符，重试中...      # 🟠 橙色：错误信息
```

### 📈 性能监控

- **请求队列**: 实时监控队列长度
- **线程池**: 动态调整线程数量
- **响应时间**: 自动记录 API 调用耗时
- **错误率**: 统计各类错误发生频率

## 🚨 故障排除

### 🔧 常见问题速查

| 问题 | 症状 | 解决方案 |
|------|------|----------|
| ❌ 配置错误 | 缺少 API 配置 | 检查 `config.json` 完整性 |
| 🔑 认证失败 | API 返回 401 | 确认 `SF_API_TOKEN` 格式 |
| 🌐 网络问题 | 连接超时 | 检查防火墙和代理设置 |
| 💾 编码错误 | 乱码显示 | 确保 UTF-8 编码 |
| 🔌 端口占用 | 启动失败 | 修改端口或关闭占用程序 |

### 🛠️ 调试技巧

1. **启用详细日志**: 取消注释 `print(f'{base_prompt}\n{translations}')`
2. **测试 API 连通性**: 使用 curl 直接测试 SiliconFlow API
3. **检查字典加载**: 监控控制台的字典加载信息
4. **验证编码**: 确保所有文件使用 UTF-8 编码

## 🚀 性能优化建议

### ⚡ 系统级优化

1. **连接池复用**: 启用 requests 连接池
2. **缓存机制**: 对常见翻译结果进行缓存
3. **负载均衡**: 多服务器部署分担负载
4. **CDN 加速**: 静态资源配置 CDN


## 📋 更新日志

### v2.0 (当前版本)
- ✅ 新增 SiliconFlow API 支持
- ✅ 智能重试机制（5次重试）
- ✅ 自定义字典功能
- ✅ 彩色日志输出
- ✅ 高性能异步处理

### v1.0
- 使用腾讯的API，兼容其他openai接口的api：https://github.com/0001lizhubo/XUnity.AutoTranslator-deepseek


## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！



**⭐ 如果这个项目对您有帮助，请给我一个 Star！**

*文档版本: v2.0*
